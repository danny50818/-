<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>差旅費核銷系統 (V22 最終修正版) - 桃園中心</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        .section { margin-bottom: 25px; padding: 20px; border-radius: 8px; border: 1px solid #e1e1e1; }
        .sec-import { background: #eafaf1; border-color: #27ae60; border-style: dashed; border-width: 2px; }
        
        textarea.import-area { width: 100%; height: 80px; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; font-family: monospace; font-size: 0.9em; }
        textarea.gmap-paste { 
            width: 95%; height: 35px; padding: 5px; 
            border: 1px solid #3498db; border-radius: 4px; 
            background-color: #f4faff; font-size: 0.8em; resize: none; transition: height 0.2s;
        }
        textarea.gmap-paste:focus { height: 100px; box-shadow: 0 0 8px rgba(52,152,219,0.4); }

        table { width: 100%; border-collapse: collapse; font-size: 0.9em; background: white; }
        th { background-color: #34495e; color: white; padding: 10px 5px; position: sticky; top: 0; z-index: 10; text-align: center;}
        td { border-bottom: 1px solid #eee; padding: 8px 5px; vertical-align: middle; text-align: center;}
        tr:hover { background-color: #f8f9fa; }

        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s;}
        .btn-import { background: #27ae60; width: 100%; font-size: 1.1em; }
        .btn-del { background: #e74c3c; padding: 4px 8px; font-size: 0.8em; }
        
        input.result-text { 
            width: 95%; padding: 5px; font-size: 0.85em; 
            border: 1px solid #bdc3c7; background: #eee; color: #333; cursor: copy; font-weight: bold;
        }
        input.result-text:hover { background: #e8f8f5; border-color: #1abc9c; }

        .fee-cell { font-weight: bold; font-size: 1.1em; cursor: pointer; transition: background 0.2s; border-radius: 4px; padding: 5px; }
        .fee-cell:hover { background-color: #fcf3cf; box-shadow: 0 0 3px #f1c40f; }
        .fee-trans { color: #2980b9; }
        .fee-misc { color: #d35400; }
        
        .fee-adjusted { color: #c0392b !important; text-decoration: underline dotted; }
        .warning-bg { background-color: #fdebd0; }
        
        .daily-limit-box { text-align: left; font-size: 0.85em; color: #555; background: #fff8e1; padding: 5px; border-radius: 4px; border: 1px solid #f1c40f; }
        .copy-btn { cursor: pointer; background: white; border: 1px solid #aaa; padding: 2px 6px; border-radius: 4px; font-weight: bold; color: #d35400; margin-left: 5px; }
        .copy-btn:hover { background: #eee; border-color: #d35400; }
        
        .config-label { font-size: 0.8em; color: #666; cursor: pointer; display: block; margin-top: 3px; font-weight:bold; color:#2c3e50;}
        .config-label input { vertical-align: middle; margin-right: 3px; }
        .calc-info { font-size: 0.75em; color: #27ae60; font-weight: bold; display: block; margin-top: 2px;}

        .grand-total { position: sticky; bottom: 0; background: #2c3e50; color: white; padding: 15px; text-align: right; font-size: 1.2em; font-weight: bold; border-radius: 5px; margin-top: 10px; z-index: 100;}
    </style>
</head>
<body>

<div class="container">
    <h2>差旅費核銷系統 (V22 最終修正版)</h2>

    <div class="section sec-import">
        <h3 style="margin:0 0 10px 0; color:#27ae60;">步驟 1：匯入差勤資料</h3>
        <div style="font-size:0.9em; color:#555; margin-bottom:5px;">請全選複製網頁上的表格 (含日期、時間、車種、事由)，貼入下方：</div>
        <textarea class="import-area" id="importText" placeholder="支援亂數金額與擠在一起的文字格式..."></textarea>
        <button class="btn btn-import" onclick="parseImport()">⚡ 解析並建立行程表</button>
    </div>

    <div style="overflow-x: auto;">
        <table id="tripTable">
            <thead>
                <tr>
                    <th width="4%">刪</th>
                    <th width="8%">日期</th>
                    <th width="6%">時數</th>
                    <th width="8%">車種</th>
                    <th width="12%">事由</th>
                    <th width="20%">
                        Google Maps 詳細文字<br>
                        <span style="font-size:0.7em; font-weight:normal; color:#bdc3c7;">(邏輯: 頭尾相減=單程)</span>
                    </th>
                    <th width="8%">設定</th>
                    <th width="18%">產出文字 (點擊複製)</th>
                    <th width="6%">車資<br><span style="font-size:0.7em;">(捨去法)</span></th>
                    <th width="6%">雜費<br><span style="font-size:0.7em;">(自動平帳)</span></th>
                    <th width="10%">當日上限/說明</th>
                </tr>
            </thead>
            <tbody id="tripBody">
                </tbody>
        </table>
    </div>

    <div class="grand-total">
        車資總計 $<span id="sumTrans">0</span> + 
        雜費總計(依日上限) $<span id="sumMisc">0</span> = 
        總請款金額 $<span id="sumGrand">0</span>
    </div>
</div>

<script>
    let tripData = [];

    // --- 核心 1: 智慧分列演算法 ---
    function parseImport() {
        const text = document.getElementById('importText').value;
        const tbody = document.getElementById('tripBody');
        tbody.innerHTML = "";
        tripData = [];

        if (!text.trim()) { alert("請先貼上資料"); return; }

        const rowRegex = /(\d+\s*元)?\s*(\d{1,2}-\d{1,2}).*?(\d{2}:\d{2})\s*~\s*(\d{1,2}-\d{1,2}).*?(\d{2}:\d{2})/g;
        
        let matches = [];
        let match;
        while ((match = rowRegex.exec(text)) !== null) {
            matches.push({
                fullMatch: match[0], date: match[2], start: match[3], end: match[5],
                index: match.index, endIndex: match.index + match[0].length
            });
        }

        matches.forEach((m, i) => {
            let contentStart = m.endIndex;
            let contentEnd = (i < matches.length - 1) ? matches[i+1].index : text.length;
            let content = text.substring(contentStart, contentEnd).trim();

            let vehicle = 'car';
            if (content.includes('機車')) vehicle = 'scooter';
            else if (content.includes('公務車') || content.includes('客運')) vehicle = 'official';

            let reason = content.replace(/^\d+\s*元/, '').trim();
            const parenIndex = content.lastIndexOf(')');
            if (parenIndex !== -1 && parenIndex < content.length - 1) {
                reason = content.substring(parenIndex + 1).trim();
            }

            let isRoundTrip = false; 
            if (content.includes('桃園') && content.lastIndexOf('桃園') > 5) {
                isRoundTrip = true;
            }

            const id = 'row-' + Date.now() + '-' + i;
            tripData.push({
                id: id, date: m.date, start: m.start, end: m.end, reason: reason,
                vehicle: vehicle, isRoundTrip: isRoundTrip,
                gmapText: "", oneWayKm: 0, totalKm: 0, transportFee: 0, 
                singleTripMisc: 0, finalMisc: 0, logicMsg: ""
            });
        });

        if (tripData.length === 0) alert("無法辨識資料格式");
        renderTrips();
        calculateAll();
    }

    function renderTrips() {
        const tbody = document.getElementById('tripBody');
        tbody.innerHTML = "";

        tripData.forEach(trip => {
            const tr = document.createElement('tr');
            tr.id = trip.id;

            let vSelect = `
                <select onchange="updateVehicle('${trip.id}', this.value)" style="padding:2px; width:100%;">
                    <option value="car" ${trip.vehicle==='car'?'selected':''}>汽車($3)</option>
                    <option value="scooter" ${trip.vehicle==='scooter'?'selected':''}>機車($2)</option>
                    <option value="official" ${trip.vehicle==='official'?'selected':''}>公務車($0)</option>
                </select>
            `;

            let duration = getDuration(trip.start, trip.end);

            tr.innerHTML = `
                <td><button class="btn btn-del" onclick="removeTrip('${trip.id}')">X</button></td>
                <td style="font-weight:bold; color:#2c3e50;">${trip.date}</td>
                <td style="color:#2980b9;">${duration.toFixed(1)} hr</td>
                <td>${vSelect}</td>
                <td style="text-align:left; font-size:0.85em;">${trip.reason}</td>
                <td>
                    <textarea class="gmap-paste" placeholder="貼上 Google Maps 文字..." oninput="processMapText('${trip.id}', this.value)">${trip.gmapText}</textarea>
                    <span class="calc-info" id="info-${trip.id}"></span>
                </td>
                <td style="text-align:center;">
                    <label class="config-label">
                        <input type="checkbox" ${trip.isRoundTrip ? '' : 'checked'} onchange="updateRoundTrip('${trip.id}', !this.checked)">
                        原路返回(x2)
                    </label>
                </td>
                <td>
                    <input type="text" class="result-text" id="out-${trip.id}" readonly value="單程0.0KM/全程0.0KM" onclick="copyOutput(this)">
                </td>
                <td class="fee-cell fee-trans" id="trans-${trip.id}" onclick="copyNum(this)" title="點擊複製">$${trip.transportFee}</td>
                <td class="fee-cell fee-misc" id="misc-${trip.id}" onclick="copyNum(this)" title="點擊複製">$0</td>
                <td id="limit-${trip.id}" style="vertical-align:top;"></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 更新邏輯 ---
    function removeTrip(id) {
        tripData = tripData.filter(t => t.id !== id);
        renderTrips();
        calculateAll();
    }

    function updateVehicle(id, val) {
        const trip = tripData.find(t => t.id === id);
        if(trip) { trip.vehicle = val; recalculateSingleTrip(trip); calculateAll(); }
    }

    function updateRoundTrip(id, isRound) {
        const trip = tripData.find(t => t.id === id);
        if(trip) { 
            trip.isRoundTrip = isRound; 
            // 關鍵修正：勾選改變時，強制重新執行里程計算邏輯
            recalculateSingleTrip(trip); 
            calculateAll(); 
        }
    }

    function processMapText(id, text) {
        const trip = tripData.find(t => t.id === id);
        if(trip) { 
            trip.gmapText = text; 
            recalculateSingleTrip(trip);
            calculateAll(); 
        }
    }

    // --- 核心 2: 統一的里程解析與計算函式 ---
    function recalculateSingleTrip(trip) {
        // 1. 解析 Google Maps 文字
        const regex = /\(([\d.]+)\s*(公里|公尺)\)/g;
        let matches = [];
        let match;
        const text = trip.gmapText;
        
        while ((match = regex.exec(text)) !== null) {
            let val = parseFloat(match[1]);
            const unit = match[2];
            if (unit === '公尺') val = val / 1000;
            matches.push(val);
        }

        if (matches.length === 0) {
            const num = parseFloat(text);
            if(!isNaN(num) && text.length < 10) { matches.push(num); } 
            else { 
                trip.oneWayKm = 0; trip.totalKm = 0; 
                trip.logicMsg = "等待輸入..."; 
                updateFee(trip); 
                return; 
            }
        }

        // 2. 應用 V20 頭尾直算邏輯
        const firstVal = matches[0];
        const lastVal = matches[matches.length - 1];
        let oneWay = 0;
        let totalRaw = 0;

        if (matches.length >= 2 && firstVal > lastVal) {
            oneWay = parseFloat((firstVal - lastVal).toFixed(2));
            totalRaw = firstVal; 
            trip.logicMsg = `頭尾相減: ${firstVal} - ${lastVal}`;
        } else {
            // 備用累加邏輯
            let cleanSegments = [];
            matches.forEach(val => {
                let currentSum = 0;
                let foundSubset = false;
                let removeCount = 0;
                for (let i = cleanSegments.length - 1; i >= 0 && i >= cleanSegments.length - 20; i--) {
                    currentSum += cleanSegments[i];
                    removeCount++;
                    let tolerance = 0.1; 
                    if (removeCount > 1) tolerance = 0.5; 
                    if (val > 50) tolerance = 2.0;
                    if (Math.abs(currentSum - val) <= tolerance) { foundSubset = true; break; }
                }
                if (foundSubset) { cleanSegments.splice(cleanSegments.length - removeCount, removeCount); cleanSegments.push(val); }
                else { cleanSegments.push(val); }
            });
            
            let allLegsTotal = cleanSegments.reduce((a,b)=>a+b, 0);
            if (cleanSegments.length > 1) {
                const lastLeg = cleanSegments[cleanSegments.length - 1];
                oneWay = parseFloat((allLegsTotal - lastLeg).toFixed(2));
            } else {
                oneWay = parseFloat(allLegsTotal.toFixed(2));
            }
            totalRaw = parseFloat(allLegsTotal.toFixed(2));
            trip.logicMsg = `累加計算`;
        }

        if (oneWay < 0) oneWay = 0;
        trip.oneWayKm = oneWay;

        // 3. 決定全程里程 (關鍵點：這裡決定費率基礎)
        if (!trip.isRoundTrip) { 
            // 勾選原路返回 -> 全程 = 單程 * 2
            trip.totalKm = parseFloat((oneWay * 2).toFixed(2));
        } else {
            // 未勾選 -> 全程 = 原始總里程
            trip.totalKm = parseFloat(totalRaw.toFixed(2));
        }

        // 更新 UI 提示文字
        const infoEl = document.getElementById(`info-${trip.id}`);
        if(infoEl) infoEl.innerText = `認定全程: ${trip.totalKm} KM`;

        updateFee(trip);
    }

    // --- 核心 3: 費用更新 ---
    function updateFee(trip) {
        // 更新車資
        if (trip.vehicle === 'official') {
            trip.transportFee = 0;
        } else {
            const rate = (trip.vehicle === 'car') ? 3 : 2;
            trip.transportFee = Math.floor(trip.totalKm * rate);
        }

        // 更新單次雜費試算
        let duration = getDuration(trip.start, trip.end);
        let miscFee = 0;
        
        if (trip.oneWayKm >= 5 && duration > 0) {
            const isLong = duration > 4;
            if (trip.oneWayKm < 30) miscFee = isLong ? 200 : 100;
            else if (trip.oneWayKm < 60) miscFee = isLong ? 300 : 150;
            else miscFee = isLong ? 400 : 200;
        }
        trip.singleTripMisc = miscFee;
        trip.finalMisc = miscFee;
        
        // 更新文字欄位
        const outInput = document.getElementById(`out-${trip.id}`);
        if(outInput) outInput.value = `單程${trip.oneWayKm.toFixed(1)}KM/全程${trip.totalKm.toFixed(1)}KM`;
    }

    // --- 核心 4: 自動平帳與 DOM 更新 ---
    function calculateAll() {
        const totalTrans = tripData.reduce((sum, t) => sum + t.transportFee, 0);
        document.getElementById('sumTrans').innerText = totalTrans;

        let dailyStats = {};
        
        // 分組
        tripData.forEach(trip => {
            if (!dailyStats[trip.date]) { 
                dailyStats[trip.date] = { totalHours: 0, maxOneWay: 0, trips: [], limit: 0 }; 
            }
            const day = dailyStats[trip.date];
            day.totalHours += getDuration(trip.start, trip.end);
            if (trip.oneWayKm > day.maxOneWay) day.maxOneWay = trip.oneWayKm;
            day.trips.push(trip);
        });

        let grandTotalMisc = 0;

        // 平帳
        Object.values(dailyStats).forEach(day => {
            let limit = 0;
            if (day.maxOneWay >= 5) {
                const isDayLong = day.totalHours > 4;
                if (day.maxOneWay < 30) limit = isDayLong ? 200 : 100;
                else if (day.maxOneWay < 60) limit = isDayLong ? 300 : 150;
                else limit = isDayLong ? 400 : 200;
            }
            day.limit = limit;
            grandTotalMisc += limit;

            let currentSum = day.trips.reduce((s, t) => s + t.singleTripMisc, 0);
            let excess = currentSum - limit;

            day.trips.forEach(t => t.finalMisc = t.singleTripMisc);

            if (excess > 0) {
                let candidates = day.trips.filter(t => t.singleTripMisc > 0);
                if (candidates.length > 0) {
                    // 從最後一筆開始扣
                    let victim = candidates[candidates.length - 1];
                    if (victim.finalMisc >= excess) {
                        victim.finalMisc -= excess;
                    } else {
                        let remainingExcess = excess;
                        for (let i = candidates.length - 1; i >= 0; i--) {
                            let t = candidates[i];
                            if (remainingExcess <= 0) break;
                            let deduct = Math.min(t.finalMisc, remainingExcess);
                            t.finalMisc -= deduct;
                            remainingExcess -= deduct;
                        }
                    }
                }
            }
        });

        // 更新 UI
        tripData.forEach(trip => {
            const day = dailyStats[trip.date];
            const tr = document.getElementById(trip.id);
            const transCell = document.getElementById(`trans-${trip.id}`);
            const miscCell = document.getElementById(`misc-${trip.id}`);
            const limitCell = document.getElementById(`limit-${trip.id}`);

            transCell.innerText = `$${trip.transportFee}`;
            miscCell.innerText = `$${trip.finalMisc}`;
            
            if (trip.finalMisc !== trip.singleTripMisc) {
                miscCell.classList.add('fee-adjusted');
                miscCell.title = `原始試算: $${trip.singleTripMisc} (已自動扣減)`;
            } else {
                miscCell.classList.remove('fee-adjusted');
                miscCell.title = "點擊複製";
            }

            if (day.trips.length > 1) tr.classList.add('warning-bg');
            else tr.classList.remove('warning-bg');

            let limitHtml = `
                <div class="daily-limit-box">
                    <div>總時: ${day.totalHours.toFixed(1)}hr</div>
                    <div>最遠: ${day.maxOneWay.toFixed(1)}km</div>
                    <div style="border-top:1px solid #ddd; margin-top:2px; padding-top:2px; font-weight:bold; color:#d35400;">
                        日上限: <span class="copy-btn" onclick="copyNum(this)" title="點擊複製">$${day.limit}</span>
                    </div>
                </div>
            `;
            limitCell.innerHTML = limitHtml;
        });

        document.getElementById('sumMisc').innerText = grandTotalMisc;
        document.getElementById('sumGrand').innerText = totalTrans + grandTotalMisc;
    }

    function getDuration(start, end) {
        if(!start || !end) return 0;
        const d1 = new Date(`2000-01-01T${start}`);
        const d2 = new Date(`2000-01-01T${end}`);
        let h = (d2 - d1) / (1000 * 60 * 60);
        if (h < 0) h += 24;
        return h;
    }

    function copyOutput(input) { input.select(); document.execCommand("copy"); flashEffect(input); }

    function copyNum(el) {
        event.stopPropagation();
        const text = el.innerText.replace(/[^\d.]/g, ''); 
        const tempInput = document.createElement("input");
        tempInput.value = text;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        flashEffect(el);
    }

    function flashEffect(el) {
        const originalBg = el.style.backgroundColor;
        el.style.backgroundColor = "#f1c40f";
        setTimeout(() => { el.style.backgroundColor = originalBg; }, 200);
    }
</script>

</body>
</html>